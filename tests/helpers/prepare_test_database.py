# SPDX-FileCopyrightText: 2022-present Maximilian Kalus <info@auxnet.de>
#
# SPDX-License-Identifier: MIT

import psycopg2


def prepare_test_database(fill_test_data: bool = True):
    try:
        # First: create db
        conn = psycopg2.connect("host=localhost dbname=postgres user=postgres password=12345")
        conn.set_isolation_level(0)
        cur = conn.cursor()

        # drop database and recreate it
        cur.execute('DROP DATABASE IF EXISTS sitt_test')
        cur.execute('CREATE DATABASE sitt_test WITH OWNER postgres')

        cur.close()
        conn.close()

        # Re-open connection on correct database
        conn = psycopg2.connect("host=localhost dbname=sitt_test user=postgres password=12345")
        conn.set_isolation_level(0)
        cur = conn.cursor()

        # create extension and schema
        cur.execute('CREATE EXTENSION postgis')
        cur.execute('CREATE SCHEMA topology')

        # create rechubs
        cur.execute('CREATE TABLE topology.rechubs'
                    ' (id TEXT PRIMARY KEY, geom geometry(PointZ, 4326), overnight TEXT);'
                    ' ALTER TABLE topology.rechubs owner TO postgres;'
                    ' CREATE INDEX sidx_rechubs_geom ON topology.rechubs USING gist (geom)')
        # create recroads
        cur.execute('CREATE TABLE topology.recroads'
                    ' (id TEXT PRIMARY KEY, geom geometry(LineStringZ, 4326), hubaid TEXT,'
                    ' hubbid TEXT); ALTER TABLE topology.recroads owner TO postgres;'
                    ' CREATE INDEX sidx_recroads_geom ON topology.recroads USING gist (geom)')
        # create recrivers
        cur.execute('CREATE TABLE topology.recrivers'
                    ' (id TEXT PRIMARY KEY, geom geometry(LineStringZ, 4326), hubaid TEXT,'
                    ' hubbid TEXT); ALTER TABLE topology.recrivers owner TO postgres;'
                    ' CREATE INDEX sidx_recrivers_geom ON topology.recrivers USING gist (geom)')

        # fill test data?
        if fill_test_data:
            cur.execute("INSERT INTO topology.rechubs (id, geom, overnight) VALUES "
                        "('PORTA_NIGRA', ST_GeomFromText('POINT (6.644151892965795 49.75965278853013 0.0)'), 'y')")
            cur.execute("INSERT INTO topology.rechubs (id, geom, overnight) VALUES "
                        "('BIB', ST_GeomFromText('POINT (6.687209246598741 49.74608947105753 0.0)'), 'y')")
            cur.execute("INSERT INTO topology.rechubs (id, geom, overnight) VALUES "
                        "('BRIDGE', ST_GeomFromText('POINT (6.626544875220759 49.751895168576425 0.0)'), 'y')")
            cur.execute("INSERT INTO topology.recroads (geom, id, hubaid, hubbid) VALUES "
                        "(ST_GeomFromText('LINESTRING (6.644056679284432 49.75969676782253 0.0, 6.644121013232677 "
                        "49.759786498253845 0.0, 6.644368114080152 49.759809166967926 0.0, 6.644524562545001 "
                        "49.759755328754295 0.0, 6.644664927523081 49.7597005459493 0.0, 6.644830148799372 "
                        "49.75970715767028 0.0, 6.645286334979403 49.75938696042499 0.0, 6.6458633646624605 "
                        "49.758980917807634 0.0, 6.647184217035004 49.758446656241375 0.0, 6.648290877130819 "
                        "49.75803154247188 0.0, 6.648460446015065 49.75798541850102 0.0, 6.64906511422285 "
                        "49.75793979186477 0.0, 6.649707557225753 49.7577511415534 0.0, 6.650356489552593 "
                        "49.75759602852517 0.0, 6.6510875620090815 49.757331443457105 0.0, 6.651362010019795 "
                        "49.757240630851214 0.0, 6.65156617358366 49.75726225273752 0.0, 6.6518607031556485 "
                        "49.757242792879936 0.0, 6.652061518773365 49.7573119834494 0.0, 6.652171967363472 "
                        "49.7574330667083 0.0, 6.652499966205852 49.75777901721048 0.0, 6.652650577918564 "
                        "49.7579303697793 0.0, 6.652744291874029 49.75796928893473 0.0, 6.653005352176848 "
                        "49.7581573977466 0.0, 6.6531392292549185 49.75829361401662 0.0, 6.6535875268086215 "
                        "49.758736645974494 0.0, 6.654284380686704 49.759450537313484 0.0, 6.654709440410073 "
                        "49.759831066897675 0.0, 6.6551302705399 49.76024831646117 0.0, 6.655371249281359 "
                        "49.76048398182601 0.0, 6.655702595050457 49.76076504911211 0.0, 6.655977043061171 "
                        "49.76098990176757 0.0, 6.656281613415587 49.76080180394408 0.0, 6.65660626533014 "
                        "49.76057478835824 0.0, 6.656997855784283 49.76030885446232 0.0, 6.657175242913979 "
                        "49.760135888544255 0.0, 6.658536695632279 49.75915567523339 0.0, 6.658796218804298 "
                        "49.759011147009005 0.0, 6.659082589201205 49.75886083719806 0.0, 6.659315265148393 "
                        "49.75879146328228 0.0, 6.659619533695235 49.758907086420436 0.0, 6.660237019863047 "
                        "49.75916145635344 0.0, 6.660657626383454 49.759213486402444 0.0, 6.6609439967803326 "
                        "49.75924239196138 0.0, 6.66131090885105 49.75930598412984 0.0, 6.661615177397891 "
                        "49.75924239196138 0.0, 6.661677820921739 49.75909786399541 0.0, 6.661668871846786 "
                        "49.75893021101507 0.0, 6.6615256866483605 49.75873365161007 0.0, 6.661534635723285 "
                        "49.75862380924252 0.0, 6.661642024621926 49.75849662303287 0.0, 6.661955242243749 "
                        "49.75846193582663 0.0, 6.662340052464344 49.758421467388416 0.0, 6.662769608059676 "
                        "49.758398342551175 0.0, 6.662823302508599 49.758190218520525 0.0, 6.662876996958374 "
                        "49.75814396861489 0.0, 6.663181265505131 49.75814396861489 0.0, 6.6633602470026005 "
                        "49.758034124911575 0.0, 6.663396043302441 49.75797631233641 0.0, 6.663297603478753 "
                        "49.75772771747725 0.0, 6.663306552553706 49.757664123238385 0.0, 6.663431839602197 "
                        "49.75763521673912 0.0, 6.663610821099695 49.7576409980405 0.0, 6.663861395197614 "
                        "49.75772193618624 0.0, 6.664201460043472 49.758034124911575 0.0, 6.664443085065614 "
                        "49.758236468382535 0.0, 6.665213340801358 49.758370639847726 0.0, 6.665965063092671 "
                        "49.75848626398931 0.0, 6.666296178863547 49.75856141953332 0.0, 6.666734683533889 "
                        "49.75867704322002 0.0, 6.6669315631820325 49.75860766904131 0.0, 6.667074748380514 "
                        "49.75849782638838 0.0, 6.6675132530500605 49.75841110832883 0.0, 6.668533447588345 "
                        "49.75816829693716 0.0, 6.6690166976333956 49.75800642200056 0.0, 6.669276220805472 "
                        "49.757913921794085 0.0, 6.669652081951114 49.75762485751156 0.0, 6.669938452348049 "
                        "49.757387823514335 0.0, 6.670206924595021 49.75713344427706 0.0, 6.670883033826755 "
                        "49.75700918321277 0.0, 6.671459032244343 49.756817810636846 0.0, 6.671960973724225 "
                        "49.756562646027646 0.0, 6.672355944067817 49.75637127168997 0.0, 6.6726028005329 "
                        "49.75626495228681 0.0, 6.672931942486855 49.75614268468544 0.0, 6.673104742038873 "
                        "49.75600446876322 0.0, 6.673363079880261 49.755766361062655 0.0, 6.6743510114174 "
                        "49.7551851259702 0.0, 6.675299297182676 49.75461277150464 0.0, 6.675775351375677 "
                        "49.75434456191118 0.0, 6.676185262296826 49.75409176940741 0.0, 6.676607594760043 "
                        "49.75385101341692 0.0, 6.676762864048584 49.753754710686195 0.0, 6.677147931883468 "
                        "49.753445738133735 0.0, 6.6776261612913 49.75308058621579 0.0, 6.678331578474143 "
                        "49.75274847072029 0.0, 6.678722857081141 49.752479619006806 0.0, 6.6793687773195245 "
                        "49.752086370532254 0.0, 6.679847006727385 49.75172522116543 0.0, 6.6801327022182875 "
                        "49.75161286303623 0.0, 6.68053019159521 49.75164496538562 0.0, 6.6809401025163595 "
                        "49.75179745125402 0.0, 6.681157479519499 49.75205025571671 0.0, 6.6814121211531585 "
                        "49.75228299516809 0.0, 6.6814928611829885 49.75242344084853 0.0, 6.681815821302223 "
                        "49.75249968261875 0.0, 6.682113938335135 49.75261605140574 0.0, 6.682381001510834 "
                        "49.75273643261568 0.0, 6.6826729077727975 49.75288088967335 0.0, 6.682995867892032 "
                        "49.75302935897838 0.0, 6.6832939849261095 49.75269630557898 0.0, 6.683449254213571 "
                        "49.75227898242835 0.0, 6.683660420445705 49.75199808982444 0.0, 6.683753901520305 "
                        "49.751820699564405 0.0, 6.684287500574982 49.75155178742051 0.0, 6.685013195290736 "
                        "49.750917424660656 0.0, 6.686421896796531 49.74957282398981 0.0, 6.687585142736481 "
                        "49.74848332534086 0.0, 6.68879660791265 49.74731890850555 0.0, 6.6889281146074495 "
                        "49.74732532166175 0.0, 6.688960370966413 49.74729966903172 0.0, 6.688751945261913 "
                        "49.74720347154883 0.0, 6.688598107242626 49.7471281167206 0.0, 6.688474044323158 "
                        "49.74711849694711 0.0, 6.688590663467153 49.74703833209168 0.0, 6.688451712997789 "
                        "49.74695977040528 0.0, 6.688226853910919 49.74687792388559 0.0, 6.688026368675452 "
                        "49.746799593286255 0.0, 6.687816558545393 49.746757415218525 0.0, 6.687741959387495 "
                        "49.746757415218525 0.0, 6.687718647151058 49.746682097149545 0.0, 6.687774596519461 "
                        "49.746585689850775 0.0, 6.687462212547274 49.74657363892541 0.0, 6.687490187231475 "
                        "49.74652844792695 0.0, 6.687335931570573 49.746336771200475 0.0, 6.68723879773799 "
                        "49.74615568356123 0.0, 6.6872058513383195 49.74608841410739 0.0)'), "
                        "'PORTA_NIGRA-BIB', 'PORTA_NIGRA', 'BIB')")
            cur.execute("INSERT INTO topology.recrivers (geom, id, hubaid, hubbid) VALUES"
                        "(ST_GeomFromText('LINESTRING (6.644151367216693 49.75965481826566 0.0, "
                        "6.644116640449113 49.75978576613784 0.0, 6.643806502176318 49.7599324735919 0.0, "
                        "6.6422926776987765 49.76039526364784 0.0, 6.639925997923655 49.761204719797405 0.0, "
                        "6.637818623835386 49.761429948828464 0.0, 6.635376783849864 49.760996785342314 0.0, "
                        "6.632766201694608 49.75989124634924 0.0, 6.630629052855795 49.759602531587376 0.0, "
                        "6.629177054524774 49.758546948312414 0.0, 6.628133540961585 49.75607738394797 0.0, "
                        "6.627397783517466 49.75491592850298 0.0, 6.626544875220759 49.751895168576425 0.0)'), "
                        "'RIVER', 'PORTA_NIGRA', 'BRIDGE')")

        cur.close()
        conn.close()

        return True
    except Exception as e:
        print()
        print(e)
        return False
